@model ABC_Retail.ViewModels.CustomerViewModel

@{
    ViewData["Title"] = "Create Customer";
}

<h1>Create New Customer</h1>

<div id="createCustomerFormContainer">
    @await Html.PartialAsync("_CreateCustomerForm", Model)
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            $('#createCustomerFormContainer').on('submit', '#createCustomerForm', function(event) {
                event.preventDefault(); // Prevent the default form submission

                // Show confirmation popup
                Swal.fire({
                    title: 'Confirm Creation',
                    text: 'Are you sure you want to create this customer?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, create it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading popup
                        Swal.fire({
                            title: 'Creating Customer',
                            text: 'Please wait...',
                            icon: 'info',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Append /CreatingCustomer... to the URL
                        const originalUrl = window.location.href;
                        window.history.replaceState({}, '', window.location.pathname + '/CreatingCustomer');

                        // Submit the form via AJAX
                        $.ajax({
                            url: '@Url.Action("Create", "Customer")',
                            type: 'POST',
                            data: $('#createCustomerForm').serialize(),
                            success: function(data) {
                                if (data.success) {
                                    // Show success popup
                                    Swal.fire({
                                        title: 'Customer Created',
                                        text: data.message,
                                        icon: 'success'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.history.replaceState({}, '', originalUrl);
                                            window.location.href = '@Url.Action("Index", "Customer")';
                                        }
                                    });
                                } else {
									Swal.fire({
										title: 'Error',
										text: data.message,
										icon: 'error'
									}).then(result => {
										if (result.isConfirmed) {
											// Revert URL back to original before reloading
											window.history.replaceState({}, '', originalUrl);
											// Replace the form with the returned HTML to show validation errors
											$('#createCustomerFormContainer').html(data);
										}
									});
                                }
                            },
                            error: function() {
                                // Handle errors
                                Swal.fire({
                                    title: 'Error',
                                    text: 'An error occurred while creating the customer.',
                                    icon: 'error'
                                }).then(result => {
                                    if (result.isConfirmed) {
                                        // Revert URL back to original before reloading
                                        window.history.replaceState({}, '', originalUrl);
                                    }
                                });
                            }
                        });
                    }
                });
            });
        });
    </script>
}
