@model IEnumerable<ABC_Retail.ViewModels.ProductViewModel>

@{
	ViewData["Title"] = "Products";
}

<head>
	<style>
		.product-card-wrapper {
			width: 300px;
			margin: 15px;
		}

		.product-card {
			transition: transform 0.3s ease, box-shadow 0.3s ease;
			border-radius: 15px;
			overflow: hidden;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

			.product-card:hover {
				transform: scale(1.05);
				box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
			}

			.product-card img {
				height: 200px;
				object-fit: cover;
				border-top-left-radius: 15px;
				border-top-right-radius: 15px;
			}

			.product-card .card-body {
				padding: 15px;
			}

			.product-card .card-footer {
				background-color: #f8f9fa;
				border-top: 1px solid #e9ecef;
				padding: 10px;
				text-align: center;
			}

		.btn-primary, .btn-success {
			border-radius: 10px;
			transition: background-color 0.3s ease, transform 0.3s ease;
		}

			.btn-primary:hover, .btn-success:hover {
				transform: translateY(-2px);
				background-color: darken($color: #007bff, $amount: 10%);
			}
	</style>
</head>

<h1>Products</h1>

@if (!Model.Any())
{
	<p>No products available. <a href="@Url.Action("Create", "Product")">Add a new product</a></p>
}
else
{
	<a class="btn btn-primary mb-3" href="@Url.Action("Create", "Product")">Add Product</a>

    <div class="d-flex flex-wrap justify-content-center">
        @foreach (var product in Model)
        {
            <div class="product-card-wrapper">
                <div class="card h-100 product-card">
                    <img src="@product.FileUrl" class="card-img-top" alt="@product.Name">
                    <div class="card-body">
                        <h5 class="card-title">@product.Name</h5>
                        <p class="card-text text-muted">@product.Price.ToString("C", new System.Globalization.CultureInfo("en-ZA"))</p>
                        <p class="card-text">@product.Description</p>
                        <p class="card-text">Quantity: <span class="product-quantity">@product.Quantity</span></p>
                    </div>
                    <div class="card-footer d-flex justify-content-between">
                        <a class="btn btn-success purchase-button" data-id="@product.Id">Purchase</a>
                        <a href="@Url.Action("Manage", "Product", new { id = product.Id })" class="btn btn-primary">Manage</a>
                    </div>
                </div>
            </div>
        }
    </div>
}

@section Scripts {
	<script>
		$(document).ready(function() {
			$('.purchase-button').click(function() {
				var button = $(this);
				var productId = button.data('id');

				// Show confirmation popup
				Swal.fire({
					title: 'Confirm Purchase',
					text: 'Are you sure you want to purchase this product?',
					icon: 'question',
					showCancelButton: true,
					confirmButtonText: 'Yes, purchase it!',
					cancelButtonText: 'Cancel'
				}).then((result) => {
					if (result.isConfirmed) {
						// Show loading popup
						Swal.fire({
							title: 'Processing Purchase',
							text: 'Please wait...',
							icon: 'info',
							allowOutsideClick: false,
							didOpen: () => {
								Swal.showLoading();
							}
						});

						$.ajax({
							url: '/Product/Purchase',
							type: 'POST',
							data: { id: productId },
							success: function(data) {
								// Update the specific product quantity container
								button.closest('.card').find('.product-quantity').text(data.quantity);

								// Wait 200ms before showing the success popup
								setTimeout(function() {
									Swal.fire({
										title: 'Purchase Successful',
										text: 'The product has been purchased.',
										icon: 'success'
									}).then((result) => {
										if (result.isConfirmed) {
											location.reload();
										}
									});
								}, 200);
							},
							error: function() {
								// Handle errors
								Swal.fire({
									title: 'Error',
									text: 'An error occurred while processing the purchase.',
									icon: 'error'
								});
							}
						});
					}
				});
			});
		});
	</script>
}